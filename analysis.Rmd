## Ilse Dippenaar and Sam Gilbert
Poll data received from:
https://www.kaggle.com/fivethirtyeight/2016-election-polls

Election results compiled from:
http://www.cnn.com/election/results/president

The dataset we decided to analyze was polling data from the 2016 U.S. presidential election. Originally the dataset included 2 duplicates of the initial polling data, but modified to fit alternative models. In our analysis, we have filtered these additional models out. We then filtered additional unnecessary columns. The remaining variables in our dataset are as follows:

  state: The U.S. state for which the poll was predicting a winner. U.S. means it was a national poll.
  startdate: The time the poll began.
  enddate: The time the poll ended.
  pollster: The organization running the poll.
  grade: The letter grade of the quality of the poll.
  samplesize: The number of people polled.
  population: The type of people polled. In this case, "lv" = "likely voters", "rv" = "registered voters", "a" = "adults" and "v" = voters. 
  poll_wt: A factor used in the adjusted poll values based on a number of factors including sample size and the time of the poll. 
  rawpoll_clinton: The raw percentage awarded to Clinton.
  rawpoll_trump: The raw percentage awarded to Trump.
  rawpoll_johnson: The raw percentage awarded to Johnson.
  poll_id: The unique integer assigned to each poll.
  
  For more information on the adjustments for adjpoll variables, see:
  https://fivethirtyeight.com/features/a-users-guide-to-fivethirtyeights-2016-general-election-forecast/

```{r, message=F}
require(mosaic)
require(ggplot2)
require(rpart)
require(dplyr)
require(class)
```

```{r}
predicted <- function(clinton, trump, johnson) {
  pred <- apply(cbind(clinton, trump, johnson), 1, which.max)
  ifelse(pred == 1, "Clinton", ifelse(pred == 2, "Trump", "Johnson"))
}
```


```{r}
make_state_results_data_frame <- function() {
  # national_2016.csv from https://econsnapshot.com/2016/11/30/our-election-data/
  county_raw <- read.csv("national_2016.csv", stringsAsFactors = F)
  state_results_raw1 <- county_raw %>%
    group_by(state) %>%
    mutate(total_votes = sum(votes)) %>%
    group_by(candidate, add = T) %>%
    # total votes will be the same across candidates
    summarize(percent = (sum(votes) / total_votes[1] * 100))
  
  state_abbrevs <- read.csv("state_abbrevs.csv", stringsAsFactors = F)
  # Initialize empty data frame with column names
  all_candidate_names <- unique(state_results_raw1$candidate)
  make_new_row <- function() {
    new_df <- data.frame(state="")
    for (candidate in all_candidate_names) {
      new_df[candidate] <- 0
    }
    return(new_df)
  }
  state_results_raw2 <- make_new_row()
  state_results_raw2 <- state_results_raw2[-1,]
  for (state_ab in unique(state_results_raw1$state)) {
    current_result <- subset(state_results_raw1, state == state_ab)
    state_name <- subset(state_abbrevs, state_abbrev == state_ab)[["state_name"]]
    next_row <- make_new_row()
    next_row["state"] <- state_name
    for (i in 1:nrow(current_result)) {
      next_row[current_result[["candidate"]][i]] <- current_result[["percent"]][i]
    }
    state_results_raw2 <- rbind(state_results_raw2, next_row)
  }
  clinton <- apply(state_results_raw2[c("Clinton", "H. Clinton", "Hillary Clinton")], 1, sum)
  trump <- apply(state_results_raw2[c("Trump", "D. Trump", "Donald Trump")], 1, sum)
  johnson <- apply(state_results_raw2[c("G. Johnson", "Gary Johnson")], 1, sum)
  other <- apply(state_results_raw2[-1], 1, sum) - clinton - trump - johnson
  
  total_votes <- sum(county_raw$votes)
  votes_clinton <- sum(subset(county_raw,
                          candidate %in% c("Clinton", "H. Clinton", "Hillary Clinton"))$votes)
  votes_trump <- sum(subset(county_raw,
                          candidate %in% c("Trump", "D. Trump", "Donald Trump"))$votes)
  votes_johnson <- sum(subset(county_raw,
                          candidate %in% c("G. Johnson", "Gary Johnson"))$votes)
  votes_other <- total_votes - (votes_clinton + votes_trump + votes_johnson)
  
  ret <- data.frame(state=state_results_raw2[["state"]],
                    actual_clinton = clinton, 
                    actual_trump = trump, 
                    actual_johnson = johnson, 
                    actual_other = other,
                    stringsAsFactors = F)
  rbind(ret, data.frame(state = "U.S.", 
                        actual_clinton = votes_clinton / total_votes * 100,
                        actual_trump = votes_trump / total_votes * 100,
                        actual_johnson = votes_johnson / total_votes * 100,
                        actual_other = votes_other / total_votes * 100))
}
state_results <- make_state_results_data_frame()
```


```{r, message=F, warning=F}
# TODO: combine congressional districts
outcomes <- read.csv("outcomes.csv", sep=",", strip.white = T, stringsAsFactors = F)
raw <- read.csv("presidential_polls.csv", sep=",", strip.white = T, stringsAsFactors = F)
poll_quality <- data.frame(grade = c("A+", "A", "A-",
                                    "B+", "B", "B-",
                                    "C+", "C", "C-",
                                    "D+", "D", "D-",
                                    ""), 
                          gradeValue = c(12:1, NA), 
                          stringsAsFactors = F)

d <- raw %>% 
  filter(type == "polls-only") %>%
  select(-c(cycle, branch, type, matchup, forecastdate, multiversions, timestamp, 
            rawpoll_mcmullin, adjpoll_mcmullin, question_id, createddate, url, 
            adjpoll_clinton, adjpoll_trump, adjpoll_johnson)) %>%
  left_join(outcomes, by = "state") %>%
  left_join(poll_quality, by = "grade") %>%
  left_join(state_results, by = "state") %>%
  filter(!is.na(result)) %>%
  mutate(predicted = predicted(rawpoll_clinton, rawpoll_trump, rawpoll_johnson),
         is_wrong = predicted != result)
d["error"] <- apply(
  d[c("rawpoll_clinton", "rawpoll_trump", "rawpoll_johnson")] - 
    d[c("actual_clinton", "actual_trump", "actual_johnson")], 1, function(row) mean(abs(row), na.rm = T))
d["duration"] <- as.numeric(as.Date(d[["enddate"]], "%m/%d/%Y") - as.Date(d[["startdate"]], "%m/%d/%Y"))
```


```{r}
pres_colors <- c("#14B3F5", "#DD342F")
ggplot(d, aes(rawpoll_clinton, rawpoll_trump, color=result)) +
  geom_point(size = 0.5) +
  xlim(0, 100) + ylim(0, 100) +
  scale_color_manual(values = pres_colors, name = "Result") +
  labs(x = "Clinton Percent", y = "Trump Percent") +
  theme_light() +
  theme(aspect.ratio = 1)
```


```{r}
mod <- prcomp(d %>% 
                filter(!is.na(rawpoll_johnson)) %>% 
                select(rawpoll_clinton, rawpoll_trump, rawpoll_johnson), scale. = T)
components <- mod$x
```


```{r}
ggplot(d %>% filter(!is.na(rawpoll_johnson)), aes(components[,1], components[,2], color=result)) + 
  geom_point(alpha = 1, size = 0.5) +
  scale_color_manual(values = pres_colors) +
  labs(x = "Principal Component 1", y = "Principal Component 2") +
  theme_light() +
  theme(aspect.ratio = 1)
```

```{r}
d %>%
  filter(!is.na(gradeValue)) %>%
  ggplot(aes(is_wrong, gradeValue)) +
  geom_boxplot()
```

So, grade value has no bearing on whether or not the poll predicted the election correctly... does anything else? Maybe duration, time it started, time it ended, or location?

```{r}
summary(lm(error ~ gradeValue, data = d))
```
So the error rate is not dependent on grade, but maybe incredibly slightly. 
 
 
```{r}
states <- map_data("state") %>% 
  left_join(d %>%
               filter(state != "U.S.") %>% 
               mutate(state = tolower(state)) %>%
               group_by(state) %>% 
               summarize(error = mean(error)), by=c("region" = "state"))
ggplot() +
  geom_polygon(data = states, aes(long, lat, group = group, fill=error), color="black") +
  coord_fixed(1.3) +
  scale_fill_gradient(low = "white", high = "red", name = "Error") +
  theme_map()
```

```{r}
table(d$predicted, d$is_wrong)/nrow(d)
d %>% 
  ggplot(aes(predicted, error, col=result)) +
  geom_point()
```


